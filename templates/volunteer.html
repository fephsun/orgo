{% extends "base.html" %}

{% block jsimport %}
<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src="http://felixsun.scripts.mit.edu/orgo/static/jquery-1.9.0.js"></script>
<script src="http://felixsun.scripts.mit.edu/orgo/static/jquery-ui-1.10.0.custom.js"></script>
<script src="http://felixsun.scripts.mit.edu/orgo/static/jquery-ui-1.10.0.custom.min.js"></script>
<script type='text/javascript' src='http://jsplumb.org/js/jquery.jsPlumb-1.3.16-all-min.js'></script>
<script src = "http://felixsun.scripts.mit.edu/orgo/static/synthesisProblemInterface.js"> </script>
{% endblock %}


{% block cssimport %}
<link rel="stylesheet" type="text/css" href="http://felixsun.scripts.mit.edu/orgo/static/jquery-ui-1.10.0.custom.min.css">
<link rel="stylesheet" type="text/css" href="http://felixsun.scripts.mit.edu/orgo/static/jquery-ui-1.10.0.custom.css">
<title>Help Others Do Orgo</title>
<link rel="stylesheet" type="text/css" href = "http://felixsun.scripts.mit.edu/orgo/static/problemInterface.css"  />
{% endblock %}

{% block scripts %}
<script>
var state = "Waiting";
var pk = 0;
var timeoutId = 0;
var REFRESH = 1500;
$(document).ready(function(){
    getQueue();
    $("#submit").click(submitLine);
    $("#input").keydown(function(e){
        //If the user presses the enter key (#13) while on the input box,
        //automatically submit line.
        if (e.keyCode == 13) {
            submitLine();
        }
    });
});

function submitLine(){
    if (state == "Waiting"){
        return;
    }
    //Submit a new message to the server.
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperchatpoll/",
        data: {'PK': pk,
               'message': $('#input').val()},
        success: update
    });
    //Reset the text input.
    $('#input').val("");
};

function getQueue() {
    $.ajax({
        type: "GET",
        url: "/orgo/chat/helperpoll/",
        success: function(data) {
            out = ""
            //Data contains a list of waiting users.
            nameArray = data.split(" ")
            for (i=0; i<nameArray.length; i++) {
                out += '<a href="#" onclick="connectHelpee(this.id)" id="'+nameArray[i]+'">'+nameArray[i]+'</a> <br / >'
            }
            $("#queue").html(out);
        }
    });
    timeoutId = setTimeout(getQueue, REFRESH);
}

function connectHelpee(userId) {
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperpoll/",
        data: {'username': userId},
        success: function(data) {
            $("#debug").html(data);
            jsonObject = $.parseJSON(data);
            state = "Chatting";
            pk = jsonObject.chatPK;
            $("#helperChatbox").html("You are now helping "+jsonObject.helpee+". <br />");
            $("#chatbox").css("margin-left", "100px");
            $("#target").html(jsonObject.target);
            allSetup();
            drawAllTheThings(data);
            clearTimeout(timeoutId);
            getChat();
        }
    });
}

function getChat() {
    //Gets chat messages from the server.
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperchatpoll/",
        data: {'PK': pk},
        success: update
    });
    setTimeout(getChat, REFRESH);
}

function update(data) {
    jsonObject = $.parseJSON(data);
    if (!jsonObject['open']) {
        $("#debug").html(data);
        $("#helperChatbox").html("Session dropped.  Did the other user log out?");
        state = "Waiting";
        return;
    }
    drawAllTheThings(data);
    for (i=0; i<jsonObject['length']; i++) {
        $("#helperChatbox").append(jsonObject[i] + "<br />");
    }
}
</script>
{% endblock %}


{% block content %}
<div class="container">
<div id="bigMolecule" class="bigMolecule">
</div>
<div class="row">
    <div id="leftbar" class="span9">
        <div id="queue">
        </div>

        <div id="debug">
        </div>
    </div>

    <div id="rightbar" class="span3">
        <h2>Target Molecule:</h2>
        <div id = "target">
        </div>
    </div>

</div>
<div id="chatbox">
    <div id="helperChatbox" class="messageWindow">
    </div>

    <input type="text" name="input" id="input"></input>
    <button id="submit">Submit</button>
</div>
</div>

{% endblock %}
