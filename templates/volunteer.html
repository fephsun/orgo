<html>
<head>
    <script src="http://felixsun.scripts.mit.edu/orgo/static/jquery-1.9.0.js"></script>
</head>

<script>
var state = "Waiting";
var pk = 0;
var timeoutId = 0;
var REFRESH = 1500;
$(document).ready(function(){
    getQueue();
    $("#submit").click(submitLine);
    $("#input").keydown(function(e){
        //If the user presses the enter key (#13) while on the input box,
        //automatically submit line.
        if (e.keyCode == 13) {
            submitLine();
        }
    });
});

function submitLine(){
    if (state == "Waiting"){
        return;
    }
    //Submit a new message to the server.
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperchatpoll/",
        data: {'PK': pk,
               'message': $('#input').val()},
        success: update
    });
    //Reset the text input.
    $('#input').val("");
};

function getQueue() {
    $.ajax({
        type: "GET",
        url: "/orgo/chat/helperpoll/",
        success: function(data) {
            out = ""
            //Data contains a list of waiting users.
            nameArray = data.split(" ")
            for (i=0; i<nameArray.length; i++) {
                out += '<a href="#" onclick="connectHelpee(this.id)" id="'+nameArray[i]+'">'+nameArray[i]+'</a> <br / >'
            }
            $("#queue").html(out);
        }
    });
    timeoutId = setTimeout(getQueue, REFRESH);
}

function connectHelpee(userId) {
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperpoll/",
        data: {'username': userId},
        success: function(data) {
            $("#debug").html(data);
            jsonObject = $.parseJSON(data);
            state = "Chatting";
            pk = jsonObject.chatPK;
            $("#queue").html("You are now helping "+jsonObject.helpee+".");
            clearTimeout(timeoutId);
            getChat();
        }
    });
}

function getChat() {
    //Gets chat messages from the server.
    $.ajax({
        type: "POST",
        url: "/orgo/chat/helperchatpoll/",
        data: {'PK': pk},
        success: update
    });
    setTimeout(getChat, REFRESH);
}

function update(data) {
    jsonObject = $.parseJSON(data);
    if (!jsonObject['open']) {
        $("#debug").html(data);
        $("#chatbox").html("Session dropped.  Did the other user log out?");
        state = "Waiting";
        return;
    }
    for (i=0; i<jsonObject['length']; i++) {
        $("#chatbox").append(jsonObject[i] + "<br />");
    }
}
</script>

<div id="queue">
</div>

<div id="debug">
</div>

<div id="chatbox">
</div>

<input type="text" name="input" id="input"></input>
<button id="submit">Submit</button>



</html>
